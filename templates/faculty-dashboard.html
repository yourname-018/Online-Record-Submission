<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faculty Dashboard | Record Upload System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-blue: #1e3a8a;
            --bg-light: #f4f7f6;
            --success: #22c55e;
            --danger: #ef4444;
            --text-main: #334155;
        }

        * { box-sizing: border-box; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        body { background-color: var(--bg-light); color: var(--text-main); }

        /* Navbar */
        .navbar {
            background: #2d2d2d; color: white; padding: 15px 30px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .nav-logo { height: 40px; margin-right: 15px; }
        .nav-brand { display: flex; align-items: center; font-weight: bold; font-size: 1.2rem; }
        .user-profile { display: flex; align-items: center; gap: 10px; }
        .logout-btn { background: #eee; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600; }
        .logout-btn:hover { background: #ddd; }

        /* Layout */
        .dashboard-grid {
            display: grid; grid-template-columns: 320px 1fr;
            gap: 25px; padding: 25px; min-height: calc(100vh - 70px);
        }

        .card { background: white; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 20px; }
        h3 { margin-bottom: 15px; font-weight: 600; font-size: 1rem; color: var(--text-main); border-bottom: 2px solid var(--primary-blue); padding-bottom: 8px; }

        /* Form Styling */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; color: #444; }
        .form-group input, .form-group select {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;
            font-size: 0.9rem; outline: none; transition: 0.2s;
        }
        .form-group input:focus, .form-group select:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }

        /* Multi-select styling */
        #targetStudents {
            padding: 8px;
            min-height: 120px;
        }
        #targetStudents option {
            padding: 6px;
            margin-bottom: 2px;
        }
        #targetStudents option:checked {
            background: linear-gradient(#1e3a8a, #1e3a8a);
            background-color: #1e3a8a !important;
            color: white !important;
        }

        /* Buttons */
        .btn { border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.3s; font-size: 0.9rem; }
        .btn-assign { background: var(--primary-blue); color: white; width: 100%; }
        .btn-assign:hover { background: #162e4d; }
        .btn-assign:disabled { background: #cbd5e1; cursor: not-allowed; }
        .btn-view { background: #3b82f6; color: white; }
        .btn-delete { background: var(--danger); color: white; padding: 6px 12px; }
        .btn-delete:hover { background: #dc2626; }

        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { background: #475569; color: white; padding: 12px; text-align: left; font-size: 0.85rem; }
        td { padding: 12px; border-bottom: 1px solid #e2e8f0; font-size: 0.9rem; }
        tr:hover { background: #f8fafc; }

        .empty-state { text-align: center; padding: 40px 20px; color: #999; }
        .empty-state i { font-size: 2.5rem; margin-bottom: 10px; color: #ddd; }

        /* Select visibility toggle */
        .target-options { display: none; }
        .target-options.show { display: block; }

        .loader {
            display: none;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .dashboard-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header class="navbar">
        <div class="nav-brand">
            <img src="static/logo.png" alt="Logo" class="nav-logo" onerror="this.style.display='none'">
            <span>FACULTY DASHBOARD</span>
        </div>
        <div class="user-profile">
            <i class="fas fa-user-circle"></i>
            <span id="facultyName">Faculty</span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </header>

    <div class="dashboard-grid">
        <!-- Sidebar: Assignment Form -->
        <aside class="sidebar">
            <div class="card">
                <h3><i class="fas fa-plus-circle"></i> CREATE ASSIGNMENT</h3>
                <form id="assignmentForm" onsubmit="handleCreateAssignment(event)">
                    <div class="form-group">
                        <label for="subjectName">Subject Name</label>
                        <input type="text" id="subjectName" placeholder="e.g. Database Project" required>
                    </div>

                    <div class="form-group">
                        <label for="targetType">Target Type</label>
                        <select id="targetType" onchange="toggleTargetOptions()" required>
                            <option value="all">All Students</option>
                            <option value="section">By Section</option>
                            <option value="students">Specific Students</option>
                        </select>
                    </div>

                    <div class="form-group target-options" id="sectionGroup">
                        <label for="targetSection">Section</label>
                        <select id="targetSection">
                            <option value="">Select section...</option>
                        </select>
                    </div>

                    <div class="form-group target-options" id="studentsGroup">
                        <label for="targetStudents">Select Students (Ctrl/Cmd for multiple)</label>
                        <select id="targetStudents" multiple size="5" style="font-size: 0.85rem; line-height: 1.5;">
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="deadlineDate">Deadline Date</label>
                        <input type="date" id="deadlineDate" required>
                    </div>

                    <div class="form-group">
                        <label for="deadlineTime">Deadline Time</label>
                        <input type="time" id="deadlineTime" required>
                    </div>

                    <button type="submit" class="btn btn-assign" id="submitBtn">
                        <span class="loader" id="loader"></span>
                        <span>CREATE ASSIGNMENT</span>
                    </button>
                </form>
            </div>
        </aside>

        <!-- Main: Assignments Table -->
        <main class="main-content">
            <div class="card">
                <h3>MY ASSIGNMENTS</h3>
                <div class="table-responsive">
                    <table id="assignmentsTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Subject</th>
                                <th>Target</th>
                                <th>Deadline</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="assignmentsBody">
                            <tr><td colspan="5" class="empty-state"><i class="fas fa-inbox"></i><br>No assignments yet</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ============================================
        // STATE
        // ============================================

        let assignments = [];
        let students = [];
        let sections = new Set();

        // ============================================
        // INITIALIZATION
        // ============================================

        async function initDashboard() {
            // Set min date to today
            document.getElementById('deadlineDate').min = new Date().toISOString().split('T')[0];

            // Load and display current user name
            await loadCurrentUser();
            
            await loadStudents();
            await loadAssignments();
            populateTargetSelectors();
            renderAssignmentsTable();
        }

        // ============================================
        // DATA LOADING
        // ============================================

        async function loadCurrentUser() {
            try {
                const response = await fetch('/api/user/current');
                if (response.ok) {
                    const user = await response.json();
                    document.getElementById('facultyName').textContent = user.name || 'Faculty';
                }
            } catch (error) {
                console.error('Error loading user:', error);
            }
        }

        async function loadStudents() {
            try {
                const response = await fetch('/api/faculty/students');
                if (response.ok) {
                    students = await response.json();
                    students.forEach(s => {
                        if (s.section) sections.add(s.section);
                    });
                }
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }

        async function loadAssignments() {
            try {
                const response = await fetch('/api/faculty/assignments');
                if (response.ok) {
                    assignments = await response.json();
                } else {
                    console.error('Failed to load assignments');
                }
            } catch (error) {
                console.error('Error loading assignments:', error);
            }
        }

        // ============================================
        // UI FUNCTIONS
        // ============================================

        function toggleTargetOptions() {
            const targetType = document.getElementById('targetType').value;
            document.getElementById('sectionGroup').classList.toggle('show', targetType === 'section');
            document.getElementById('studentsGroup').classList.toggle('show', targetType === 'students');
        }

        function populateTargetSelectors() {
            // Sections
            const sectionSelect = document.getElementById('targetSection');
            sections.forEach(sec => {
                const opt = document.createElement('option');
                opt.value = sec;
                opt.textContent = sec;
                sectionSelect.appendChild(opt);
            });

            // Students
            const studentsSelect = document.getElementById('targetStudents');
            students.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.studentID;
                opt.textContent = `${s.name} (${s.studentID}) [${s.section || ''}]`;
                studentsSelect.appendChild(opt);
            });
        }

        function getTargetDisplay(assignment) {
            const { targetType, targetSection, targetStudents } = assignment;

            if (targetType === 'section') {
                return targetSection || 'Section';
            } else if (targetType === 'students') {
                if (Array.isArray(targetStudents) && targetStudents.length) {
                    return `${targetStudents.length} students`;
                }
                return 'Specific Students';
            }
            return 'All Students';
        }

        function formatTime12Hour(time24) {
            const [hours, minutes] = time24.split(':');
            let hour = parseInt(hours);
            const period = hour >= 12 ? 'P.M' : 'A.M';
            if (hour > 12) hour -= 12;
            if (hour === 0) hour = 12;
            return `${hour.toString().padStart(2, '0')}:${minutes} ${period}`;
        }

        function renderAssignmentsTable() {
            const tbody = document.getElementById('assignmentsBody');

            if (!assignments.length) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><i class="fas fa-inbox"></i><br>No assignments yet</td></tr>';
                return;
            }

            tbody.innerHTML = assignments.map((a, idx) => {
                const formattedTime = a.deadlineTime ? formatTime12Hour(a.deadlineTime) : '';
                const deadline = a.deadlineDate ? `${a.deadlineDate} ${formattedTime}` : 'N/A';
                return `
                    <tr>
                        <td>${idx + 1}</td>
                        <td><strong>${escapeHtml(a.subject)}</strong></td>
                        <td>${escapeHtml(getTargetDisplay(a))}</td>
                        <td>${deadline}</td>
                        <td>
                            <button class="btn btn-view" onclick="viewSubmissions(${a.id})" title="View submissions">
                                <i class="fas fa-eye"></i> Submissions
                            </button>
                            <button class="btn btn-delete" onclick="deleteAssignment(${a.id})" title="Delete assignment">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ============================================
        // ASSIGNMENT MANAGEMENT
        // ============================================

        async function handleCreateAssignment(event) {
            event.preventDefault();

            const subject = document.getElementById('subjectName').value.trim();
            const targetType = document.getElementById('targetType').value;
            const deadlineDate = document.getElementById('deadlineDate').value;
            const deadlineTime = document.getElementById('deadlineTime').value;

            if (!subject || !deadlineDate || !deadlineTime) {
                alert('Please fill in all required fields');
                return;
            }

            let targetSection = null;
            let targetStudents = [];

            if (targetType === 'section') {
                targetSection = document.getElementById('targetSection').value;
                if (!targetSection) {
                    alert('Please select a section');
                    return;
                }
            } else if (targetType === 'students') {
                targetStudents = Array.from(document.getElementById('targetStudents').selectedOptions).map(o => o.value);
                if (!targetStudents.length) {
                    alert('Please select at least one student');
                    return;
                }
            }

            const submitBtn = document.getElementById('submitBtn');
            const loader = document.getElementById('loader');
            submitBtn.disabled = true;
            loader.style.display = 'inline-block';

            try {
                const response = await fetch('/api/faculty/create-assignment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        subject,
                        targetType,
                        targetSection,
                        targetStudents,
                        deadlineDate,
                        deadlineTime
                    })
                });

                if (response.ok) {
                    alert(`Assignment "${subject}" created successfully!`);
                    document.getElementById('assignmentForm').reset();
                    await loadAssignments();
                    renderAssignmentsTable();
                } else {
                    const data = await response.json();
                    alert(`Error: ${data.error || 'Failed to create assignment'}`);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error creating assignment. Please try again.');
            } finally {
                submitBtn.disabled = false;
                loader.style.display = 'none';
            }
        }

        async function deleteAssignment(assignmentId) {
            if (!confirm('Are you sure you want to delete this assignment?')) return;

            try {
                const response = await fetch(`/api/faculty/assignment/${assignmentId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('Assignment deleted successfully');
                    await loadAssignments();
                    renderAssignmentsTable();
                } else {
                    const data = await response.json();
                    alert(`Error: ${data.error || 'Delete failed'}`);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error deleting assignment. Please try again.');
            }
        }

        function viewSubmissions(assignmentId) {
            // Store assignment ID and redirect to submissions view
            sessionStorage.setItem('currentAssignmentId', assignmentId);
            window.location.href = '/faculty/submissions/' + assignmentId;
        }

        // ============================================
        // UTILITIES
        // ============================================

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear local storage and session storage
                localStorage.clear();
                sessionStorage.clear();
                // Redirect to logout
                window.location.href = '/logout';
            }
        }

        // ============================================
        // STARTUP
        // ============================================

        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>